#!/usr/bin/env bash

set -euo pipefail

if [ $# -ne 1 ]; then
    echo "Usage: worktree <task-name>" >&2
    exit 1
fi

TASK_NAME="$1"

# Get the original repository name and paths
ORIGINAL_REPO_DIR="$(git rev-parse --show-toplevel)"
ORIGINAL_REPO=$(basename "$ORIGINAL_REPO_DIR")
TODO_FILE="${ORIGINAL_REPO_DIR}/.llm/todo.md"

# Create worktree and branch names
WORKTREE_NAME="${ORIGINAL_REPO}-${TASK_NAME}"
BRANCH_NAME="task/${TASK_NAME}"
WORKTREE_PATH="$(dirname "$ORIGINAL_REPO_DIR")/${WORKTREE_NAME}"

# Create the git worktree
git worktree add "$WORKTREE_PATH" -b "$BRANCH_NAME" "${UPSTREAM_REMOTE:-origin}/${UPSTREAM_BRANCH:-main}" >/dev/null 2>&1

# Mark the current task as in progress only after successful worktree creation
todo-complete --progress "$TODO_FILE" >/dev/null

# Set up .llm directory and todo file
mkdir -p "${WORKTREE_PATH}/.llm"
todo-get "$TODO_FILE" > "${WORKTREE_PATH}/.llm/todo.md"

# Append completion instructions
{
    echo ""
    echo "When this task is complete:"
    echo "- Edit the original task list at \`${ORIGINAL_REPO_DIR}/.llm/todo.md\`"
    echo "- Change the todo status from \`[>]\` to \`[x]\` using todo-complete"
} >> "${WORKTREE_PATH}/.llm/todo.md"

# Copy .envrc if it exists
if [ -f ".envrc" ]; then
    cp ".envrc" "$WORKTREE_PATH/"
    direnv allow "$WORKTREE_PATH" >/dev/null 2>&1
fi

# Trust with mise
mise trust "$WORKTREE_PATH" >/dev/null 2>&1

echo "${WORKTREE_PATH}"
