#!/usr/bin/env bash

set -Eeuo pipefail

if [ $# -ne 1 ]; then
    echo "Usage: worktree <task-name>" >&2
    exit 1
fi

TASK_NAME="$1"

# Get the original repository name and paths
ORIGINAL_REPO_PATH="$(git rev-parse --show-toplevel)"
ORIGINAL_REPO_NAME=$(basename "$ORIGINAL_REPO_PATH")
TODO_FILE_PATH="${ORIGINAL_REPO_PATH}/.llm/todo.md"

# Create worktree and branch names
WORKTREE_NAME="${ORIGINAL_REPO_NAME}-${TASK_NAME}"
BRANCH_NAME="${TASK_NAME}"
WORKTREE_PATH="$(dirname "$ORIGINAL_REPO_PATH")/${WORKTREE_NAME}"

# Create the git worktree
echo "git worktree add --quiet \"$WORKTREE_PATH\" -b \"$BRANCH_NAME\" \"${UPSTREAM_REMOTE:-origin}/${UPSTREAM_BRANCH:-main}\""
git worktree add --quiet "$WORKTREE_PATH" -b "$BRANCH_NAME" "${UPSTREAM_REMOTE:-origin}/${UPSTREAM_BRANCH:-main}"

# Set up .llm directory and todo file
echo "mkdir -p \"${WORKTREE_PATH}/.llm\""
mkdir -p "${WORKTREE_PATH}/.llm"
echo "todo-get \"$TODO_FILE_PATH\" > \"${WORKTREE_PATH}/.llm/todo.md\""
todo-get "$TODO_FILE_PATH" > "${WORKTREE_PATH}/.llm/todo.md"

# Mark the current task as in progress
echo "todo-complete --progress \"$TODO_FILE_PATH\""
todo-complete --progress "$TODO_FILE_PATH"

# Append completion instructions
{
    echo ""
    echo "When this task is complete:"
    echo "- Edit the original task list at \`${ORIGINAL_REPO_PATH}/.llm/todo.md\`"
    echo "- Change the todo status from \`[>]\` to \`[x]\` using todo-complete"
} >> "${WORKTREE_PATH}/.llm/todo.md"

# Copy .envrc if it exists
if [ -f ".envrc" ]; then
    echo "cp \".envrc\" \"$WORKTREE_PATH/\""
    cp ".envrc" "$WORKTREE_PATH/"
    echo "direnv allow \"$WORKTREE_PATH\""
    direnv allow "$WORKTREE_PATH"
fi

# Trust with mise
echo "mise trust \"$WORKTREE_PATH\""
mise trust "$WORKTREE_PATH"

echo "‚úÖ Worktree created successfully!"
echo "üìÅ Path: ${WORKTREE_PATH}"
echo "üöÄ Run: cd ${WORKTREE_PATH} && claude /todo"
